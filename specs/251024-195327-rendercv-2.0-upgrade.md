# Upgrade cvgen from rendercv<2 to rendercv>=2.0

**Date:** 2025-10-24 19:53:27
**Issue:** Migrate cvgen from rendercv 1.x (LaTeX-based) to rendercv 2.0+ (Typst-based)
**Priority:** High
**Status:** Completed
**Started:** 2025-10-27
**Completed:** 2025-10-27
**Implementation:**
- Updated dependencies: pyproject.toml to require rendercv[full]>=2.0,<3
- Rewrote classicko theme using new rendercv.themes.options API
- Converted all LaTeX templates (.j2.tex) to Typst templates (.j2.typ)
- Updated example YAML files to use rendercv 2.0 design schema
- Updated documentation to remove LaTeX references and add Typst information
- Verified Korean text rendering works correctly with new version

## Problem Statement

**Current State:**
- cvgen currently depends on `rendercv>=1.13,<2` (pyproject.toml:15)
- rendercv 1.x uses LaTeX as its typesetting engine
- cvgen includes a custom theme `classicko` that extends rendercv's classic theme
- The classicko theme imports from `rendercv.themes.common_options` (static/themes/classicko/__init__.py:4-9)
- Example workflows use `rendercv render` with `--use-local-latex-command xelatex` for Korean language support (examples/basic_ko/README.md:20)

**Required State:**
- Upgrade to `rendercv>=2.0` to gain access to Typst-based rendering
- Update custom theme to work with rendercv 2.0's new theme API
- Ensure Korean/multilingual support continues to work (should be improved with Typst)
- Maintain backward compatibility with existing YAML templates where possible

**Impact:**
- **Positive**: Faster rendering, better CJK support out-of-the-box, cross-platform compatibility, no LaTeX installation required
- **Breaking**: Custom theme needs complete rewrite, theme API has changed, LaTeX-specific workarounds no longer needed

## Root Cause Analysis

### Current rendercv 1.x Integration

**Dependency Version:**
```toml
# pyproject.toml:15
rendercv>=1.13,<2
```

**Custom Theme Structure:**
The classicko theme (static/themes/classicko/__init__.py) extends rendercv's classic theme:

```python
# Lines 4-9: Imports from rendercv 1.x
from rendercv.themes.common_options import (
    EntryAreaMargins,
    LaTeXDimension,
    Margins,
    ThemeOptions,
)
```

This theme:
- Extends `ThemeOptions` from `common_options`
- Uses `LaTeXDimension` type for measurements
- Customizes `EntryAreaMargins` to add `education_degree_width` field
- Defines font choices including "Noto Sans KR" for Korean support

**Usage in Examples:**
The basic_ko example demonstrates the workflow:
```bash
# examples/basic_ko/README.md:18-20
cvgen filter extended_template.yaml --target-verbosity 1 --include-tags '' \
| cvgen collapse -k ko > output_ko.yaml \
&& rendercv render output_ko.yaml --use-local-latex-command xelatex
```

### rendercv 2.0 Breaking Changes

Based on research of rendercv 2.0 release notes and GitHub repository:

**1. Core Technology Change:**
- LaTeX replaced with Typst as typesetting engine
- Template files changed from `.j2.tex` to `.j2.typ`
- Much faster rendering (~2s to <1s per CV)
- Cross-platform support (no platform-specific LaTeX distribution needed)

**2. Theme API Restructure:**
- `rendercv.themes.common_options` module no longer exists
- New base module: `rendercv.themes.options` with `ThemeOptions` class
- Theme configuration split into granular components:
  - `Page`, `Colors`, `Text`, `Header`, `SectionTitles`
  - `Entries`, `Highlights`, `EntryTypes`
- Dimension type changed from `LaTeXDimension` to Typst dimensions (validated string format)
- Theme files now in separate component files (e.g., `Header.j2.typ`, `EducationEntry.j2.typ`)

**3. Field Renaming:**
- `locale_catalog` renamed to `locale`
- Some design fields moved from `design` to `locale`
- Design field structure completely changed

**4. CLI Changes:**
- `--use-local-latex-command` option no longer exists
- Rendering is now Typst-only, no LaTeX commands needed

**5. CJK Support Improvement:**
- Chinese, Japanese, Korean characters now supported by default
- No need for special LaTeX packages (kotex, xelatex)
- Eliminates the 50MB package size limitation that prevented CJK in rendercv 1.x

### Why This is a Breaking Change

**For cvgen specifically:**

1. **Custom Theme Must Be Rewritten:**
   - Can't import from `rendercv.themes.common_options` (doesn't exist)
   - `LaTeXDimension` type no longer exists, must use Typst dimension strings
   - Need to adopt new theme configuration structure
   - May need to create `.j2.typ` template files if customizing beyond options

2. **Documentation Needs Update:**
   - Remove references to LaTeX, xelatex, kotex
   - Update example commands to remove `--use-local-latex-command`
   - Highlight that CJK now works out-of-the-box

3. **Testing Required:**
   - Verify Korean content still renders correctly
   - Check that all example YAML templates work
   - Ensure PDF output quality is acceptable

4. **Backward Compatibility:**
   - Users with rendercv 1.x won't be able to use cvgen with rendercv 2.0
   - This is acceptable as it's a major version bump for both packages

## Technical Approach

### Migration Strategy

**Phase 1: Update Dependency**
- Update pyproject.toml to require `rendercv>=2.0`
- Run `uv sync` to install rendercv 2.0

**Phase 2: Rewrite Custom Theme**
- Study rendercv 2.0's built-in classic theme structure
- Rewrite `static/themes/classicko/__init__.py` to use new API
- Use `rendercv.themes.options.ThemeOptions` as base class
- Replace `LaTeXDimension` with Typst dimension strings
- Adopt new configuration structure (Page, Text, Header, etc.)

**Phase 3: Update Examples and Documentation**
- Update `examples/basic_ko/README.md` to remove LaTeX references
- Update Makefile to remove `--use-local-latex-command xelatex`
- Update main README.md if it references rendercv version

**Phase 4: Testing**
- Test with existing YAML templates
- Verify Korean text renders correctly
- Compare PDF output with LaTeX version
- Run existing test suite

**Why This Approach:**
- Incremental changes reduce risk
- Theme rewrite is most complex part, deserves focused attention
- Testing ensures no regression in multilingual support
- Documentation updates prevent user confusion

## Implementation Details

### Step 1: Update Dependencies

**File: pyproject.toml**

Change line 15:
```toml
# Before:
"rendercv>=1.13,<2",

# After:
"rendercv>=2.0,<3",
```

**Commands:**
```bash
uv sync
```

### Step 2: Investigate rendercv 2.0 Theme API

Before rewriting the theme, examine the new API:

```bash
# Install rendercv 2.0 and inspect
uv run python -c "import rendercv; print(rendercv.__version__)"

# Check what's available in themes.options
uv run python << 'EOF'
from rendercv.themes.options import ThemeOptions
import inspect
print(inspect.getsource(ThemeOptions.__init__))
EOF

# Examine a built-in theme for reference
uv run python << 'EOF'
from rendercv.themes.classic import ClassicThemeOptions
import inspect
print(inspect.getsource(ClassicThemeOptions))
EOF
```

### Step 3: Rewrite classicko Theme

**File: static/themes/classicko/__init__.py**

Current implementation (lines 1-65) needs complete rewrite. New structure should:

1. Import from correct module:
```python
from typing import Literal
from rendercv.themes.options import (
    ThemeOptions,
    # Other needed components like Margins, Header, etc.
)
```

2. Create configuration classes following rendercv 2.0 pattern:
```python
class ClassickoThemeOptions(ThemeOptions):
    """Theme options for classicko theme (Korean-optimized classic)."""

    theme: Literal["classicko"]

    # Configure components similar to moderncv example
    # Use Typst dimension strings instead of LaTeXDimension
    # Example: "1 cm" instead of LaTeXDimension("1 cm")
```

3. Key changes from current code:
   - Remove `EntryAreaMarginsForClassic` and `MarginsForClassic` custom classes
   - Use base classes from `rendercv.themes.options` and configure via parameters
   - Change dimension specifications from `LaTeXDimension("1 cm")` to string `"1 cm"`
   - Ensure "Noto Sans KR" font is still available in font choices

**Reference Implementation:**
Refer to rendercv 2.0's moderncv theme as a model:
- Located at: `rendercv/themes/moderncv/__init__.py` in rendercv 2.0 source
- Shows how to customize Header, Links, Text, SectionTitles, Entries, etc.
- Demonstrates proper inheritance and field definitions

**Specific Customizations to Preserve:**
- `education_degree_width` field (currently line 15-20)
  - May need to be configured via entry options in new API
  - Or via custom template if fine-grained control needed
- Font choice including "Noto Sans KR" (lines 38-45)
  - Should be available via Text options in new API
- Section timespan display (lines 50-59)
  - Should be configurable via EntryTypes options

### Step 4: Create Typst Templates (If Needed)

If the classicko theme requires customization beyond what theme options provide, create `.j2.typ` files:

**Directory Structure:**
```
static/themes/classicko/
├── __init__.py          # Theme options (rewritten)
├── Header.j2.typ        # (optional) Custom header template
├── EducationEntry.j2.typ # (optional) Custom education entry
└── ...                  # Other component templates as needed
```

**Template Format:**
Study rendercv 2.0's classic theme templates (`.j2.typ` files) for syntax:
- Typst syntax instead of LaTeX
- Jinja2 templating preserved
- Example: `https://github.com/rendercv/rendercv/tree/main/rendercv/themes/classic`

**Decision Point:**
First try to achieve desired layout with theme options alone. Only create custom templates if options are insufficient. The new API is more flexible than v1.x.

### Step 5: Update Example Documentation

**File: examples/basic_ko/README.md**

Line 5-6: Remove LaTeX warning
```markdown
# Before:
⚠️ 제대로 된 LaTeX 한글 렌더링을 위해서는 `kotex`, `xelatex` 등 **LaTeX 한글 지원 패키지가 로컬 환경에 설치**되어 있어야 합니다.

# After:
✨ rendercv 2.0은 Typst를 사용하여 별도의 LaTeX 설치 없이 한글을 포함한 다국어를 기본적으로 지원합니다.
```

Line 20: Remove `--use-local-latex-command` option
```bash
# Before:
&& rendercv render output_ko.yaml --use-local-latex-command xelatex

# After:
&& rendercv render output_ko.yaml
```

Line 110: Remove xelatex reference
```markdown
# Before:
- LaTeX 렌더링에는 미리 로컬 환경에 준비한 `xelatex` 명령어를 사용합니다. (한글 지원을 위해 필수!)
- PDF, TeX, PNG 등 다양한 형식의 출력 파일을 생성합니다.

# After:
- Typst를 사용하여 한글을 포함한 다국어 내용을 렌더링합니다.
- PDF, Typst, PNG 등 다양한 형식의 출력 파일을 생성합니다.
```

Line 122: Remove kotex reference
```markdown
# Before:
- [kotex 관련 문서 - KTUG (한글 TeX 사용자 그룹)](http://wiki.ktug.org/wiki/wiki.php/ko.TeX)

# After:
(Remove this line entirely)
```

**File: examples/basic_ko/Makefile**

Update the make target to remove xelatex:
```makefile
# Find and update the rendercv render command
# Remove --use-local-latex-command xelatex
```

### Step 6: Update Main README

**File: README.md**

Line 10: Update installation instructions (pdm -> uv)
```markdown
# Before:
pdm install

# After:
uv sync
```

Add note about rendercv 2.0 if appropriate:
```markdown
## Requirements

- Python >= 3.13.3
- rendercv >= 2.0 (uses Typst, no LaTeX required)
```

### Step 7: Testing

**Test Plan:**

1. **Verify Installation:**
```bash
uv sync
uv run cvgen --help
uv run python -c "import rendercv; print(rendercv.__version__)"  # Should be >= 2.0
```

2. **Test Korean Example:**
```bash
cd examples/basic_ko
make  # Should work without errors
# Verify output PDF has Korean characters
open rendercv_output/*.pdf  # Check for correct rendering
```

3. **Test Theme Import:**
```bash
uv run python << 'EOF'
from cvgen.static.themes.classicko import ClassickoThemeOptions
print("Theme imported successfully")
print(ClassickoThemeOptions)
EOF
```

4. **Test Complete Workflow:**
```bash
cd examples/basic_ko
cvgen filter extended_template.yaml --target-verbosity 1 --include-tags '' \
  | cvgen collapse -k ko > output_ko.yaml
rendercv render output_ko.yaml
# Verify output files generated
ls -lh rendercv_output/
```

5. **Run Existing Tests:**
```bash
uv run pytest tests/
```

6. **Visual Comparison:**
- Generate PDF with old version (rendercv 1.18)
- Generate PDF with new version (rendercv 2.0)
- Compare visually to ensure layout is acceptable
- Korean characters should render correctly in both

### Step 8: Handle Potential Issues

**Issue: Theme customization insufficient**
- **Solution**: Create custom `.j2.typ` templates as described in Step 4
- Study rendercv 2.0 source code for template syntax

**Issue: Font not available**
- **Solution**: Check Typst font support; may need to specify font fallbacks
- Typst has good Unicode support, fonts should work

**Issue: YAML structure incompatible**
- **Solution**: Most YAML should be compatible; update examples if needed
- The `design` field changed, but examples may not use it

**Issue: Dependencies conflict**
- **Solution**: Check for other packages that depend on rendercv<2
- Update or remove conflicting dependencies

**Issue: Output looks different**
- **Solution**: This is expected; Typst rendering differs from LaTeX
- Adjust theme options to match desired appearance
- May need to accept some visual differences

### Step 9: Commit Changes

Once all changes are working:

```bash
# Stage changes
git add pyproject.toml uv.lock
git add static/themes/classicko/
git add examples/basic_ko/README.md examples/basic_ko/Makefile
git add README.md

# Commit with descriptive message
git commit -m "feat: upgrade to rendercv 2.0 with Typst support

- Update dependency from rendercv>=1.13,<2 to rendercv>=2.0,<3
- Rewrite classicko theme to use rendercv.themes.options API
- Replace LaTeX-specific code with Typst equivalents
- Update documentation to remove LaTeX/xelatex references
- Improve CJK support (now works out-of-the-box)

Breaking changes:
- classicko theme API changed (internal only)
- Requires rendercv >= 2.0

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
"
```

## Success Criteria

1. ✅ pyproject.toml specifies `rendercv>=2.0,<3`
2. ✅ `uv sync` installs rendercv 2.0+ successfully
3. ✅ classicko theme imports without errors
4. ✅ Korean example renders correctly with `make`
5. ✅ Generated PDF contains properly rendered Korean text
6. ✅ All existing tests pass
7. ✅ Documentation reflects Typst (not LaTeX)
8. ✅ No references to xelatex, kotex, or LaTeX-specific tools

## Rollback Plan

If issues arise that can't be resolved quickly:

```bash
# Revert to rendercv 1.x
git revert <commit-hash>

# Or manually:
# 1. Change pyproject.toml back to "rendercv>=1.13,<2"
# 2. Revert theme changes
# 3. Revert documentation changes
# 4. Run: uv sync
```

rendercv 1.18 will remain available indefinitely as the last LaTeX-based version.

## References

- [rendercv 2.0 Release Notes](https://github.com/rendercv/rendercv/releases)
- [rendercv Documentation](https://docs.rendercv.com/)
- [Typst vs LaTeX Discussion](https://github.com/rendercv/rendercv/discussions/233)
- [rendercv 2.0 Source Code - Themes](https://github.com/rendercv/rendercv/tree/main/rendercv/themes)
- [rendercv 2.0 Classic Theme Example](https://github.com/rendercv/rendercv/tree/main/rendercv/themes/classic)
- [rendercv 2.0 ModernCV Theme Example](https://github.com/rendercv/rendercv/tree/main/rendercv/themes/moderncv)

## Notes

- The migration is a one-way upgrade; rendercv 2.0 doesn't support LaTeX templates
- Typst rendering is significantly faster than LaTeX
- CJK support improvement eliminates the need for platform-specific LaTeX packages
- Theme API is more structured but may require more boilerplate code
- Visual output may differ slightly from LaTeX version; this is expected and acceptable
